var orderApp = angular.module('orderApp',['ngRoute', 'ui.bootstrap', 'ui.bootstrap.datepicker']);

orderApp.factory('myService', function () {
	var Order = [];
	var Forms = [];

	function getOrder() {
		return Order;
	}

	function setOrder(order) {
		Order = [];
		for (i=0; order[i] != null; i++) {
			order[i].dateTimeCalendarisOpen = false;
			Order.push(order[i]);
		}	
						
	}
	function getForms() {
		return Forms;
	}

	function setForms(forms) {
		Forms = [];
		for (i=0; forms[i] != null; i++) {
			Forms.push(forms[i]);
		}	
						
	}
	
	return {
	    getOrder: getOrder,
	    setOrder: setOrder,
	    getForms: getForms,
	    setForms: setForms	    
	}
});

orderApp.config(function($routeProvider){

      $routeProvider
          .when('/',{
                templateUrl: 'home.html'
          })
                    .when('/newOrder',{
                templateUrl: 'newOrder.html'
          })

          .when('/updateOrder',{
                templateUrl: 'updateOrder.html'
          });

});



orderApp.controller('orderCtrl', function($scope, $http, myService){
			//$scope.order = myService.getOrder();
	  	
			
      	$scope.getOrder = function (id) {
			   var parameters = location.search.substring(1).split("&");
			   var eventID = null;
			
			   var temp = parameters[0].split("=");
			   if (temp != "") {
	
			   	eventID = unescape(temp[1]);
			   }
				if (!eventID) {
					// new order
					//myService.setOrder(null);					
				}
				$scope.orderID = id;

	     		$http.get("getOrder.php", { params: { ID: id }})
	     		.success(function(data) {
	             $scope.message = "From PHP file : "+data;
	             console.log($scope.message);
	      	    try {
	   	        		$scope.order = angular.fromJson(data);
	   	        		if ($scope.order)
	             			myService.setOrder($scope.order);
	             			$scope.setFormValues();	
				
		      	 }
	        		 catch (e) {
	            		console.log("did not receive a valid Json: " + e);
	            		myService.setOrder(null);
	        		 }  

				}); 
				
			};
			
			
      	$scope.getFormFields = function (form) {
				if (!$scope.forms) {
		     		$http.get("getForms.php")
		     		.success(function(data) {
		             $scope.message = "From PHP file : "+data;
		             console.log($scope.message);
		      	    try {
		   	        		$scope.forms = angular.fromJson(data);
		   	        		if ($scope.forms) {
		             			myService.setForms($scope.forms);
		             			$scope.form = $scope.forms[form];
		             			$scope.setFormValues();	
								}
			      	 }
		        		 catch (e) {
		            		console.log("did not receive a valid Json: " + e);
		            		myService.setForms(null);
		        		 }  
	
					}); 
				}
				else { // form exist - set it to current form and set it's values
					$scope.form = $scope.forms[form];				
					$scope.setFormValues();
				}

			};
	
	
			$scope.setFormValues = function()	{
					if ($scope.order) 
						for(var i=0; $scope.form && $scope.form.fields[i]; i++) {
		      			var fieldIndex = $scope.form.fields[i].fieldIndex-2;
		      			$scope.form.fields[i].value = $scope.order[fieldIndex].value;	
		      		}    		
			}
			
				
			$scope.getFormAndValues = function (form, order) {
				$scope.getFormFields(form);
				$scope.getOrder(order);
				$scope.setFormValues();
			}
			
			$scope.openDateTimeCalendar = function(e, field) {
			    e.preventDefault();
			    e.stopPropagation();
			
			    field.dateTimeCalendarisOpen = true;
			};
      
         
	      $scope.updateOrder = function () {
	      		$scope.updateValues(); 
	      		// get the order ID and send to PHP
					$scope.updatedOrder = {};
					$scope.updatedOrder.order = $scope.order;	      		
					$scope.updatedOrder.orderID = $scope.orderID;	      		
	      		
	            var content = angular.toJson($scope.updatedOrder);
	            var request = $http({
	                    method: "post",
	                    url: "updateOrder.php",
	                    data: content,
	                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
	            });
	                /* Check whether the HTTP Request is Successfull or not. */
	            request.success(function (data) {
	                $scope.message = "From PHP file : "+data;
	                console.log($scope.message);
	                alert("Order ID: "+$scope.orderID+" updated successfully");
  
	          
	            });
	            request.error(function (data, status) {
	                $scope.message = "From PHP file : "+data;
	                alert($scope.message);
	            });
	      }   
         
	      $scope.updateValues = function () {
	      	for(var i=0; $scope.form.fields[i] != null; i++) {
	      		var fieldIndex = $scope.form.fields[i].fieldIndex-2;
	      		$scope.order[fieldIndex].value = $scope.form.fields[i].value;	
	      	}         
			}
         
	      $scope.newOrder = function () {
	      	$scope.orderID = null;
	      	$scope.updateOrder();
	      	
			}     
	        
});


